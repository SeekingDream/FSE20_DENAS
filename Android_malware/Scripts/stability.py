from Android_malware.Scripts.TreeLearning import *
from Android_malware.Scripts.Denasrule import *


def transferRuleSet(RuleSet):
    NewRuleSet = set()
    for rule in RuleSet:
        str_rule = []
        for r in rule:
            str_rule.append(r[0] * 2 + r[1])
        str_rule = np.sort(str_rule)
        new_s = ''
        for r in str_rule:
            new_s += str(r) + '_'
        NewRuleSet.add(new_s)
    return NewRuleSet

def calculate_stability(testnum, max_depth = 10, rule_num = 100):
    x, _ = ReadData(year=NowYear, IsTrain=True)
    RuleSet_1 = generateDTreeRuleSet(x, testnum, maxdepth = max_depth)
    RuleSet_1 = transferRuleSet(RuleSet_1)
    RuleSet_2 = generateDTreeRuleSet(x, testnum, maxdepth= max_depth)
    RuleSet_2 = transferRuleSet(RuleSet_2)

    return len(RuleSet_1 & RuleSet_2) / (len(RuleSet_1 | RuleSet_2)) * 2


def baseline_stability():
    testnum = 1000
    print('DTExtract   1000:', calculate_stability(testnum))
    testnum = 5000
    print('DTExtract   5000:', calculate_stability(testnum))
    testnum = 10000
    print('DTExtract   10000:', calculate_stability(testnum))


def DenasValue():
    model = loadModel(2019)
    puppetModel = getPuppetModel("../model/" + str(2019) + "/MLP_model.h5")
    R_1 = gerenateDenasRule(puppetModel, model, 5, maxlength=10)
    R_1 = transferRuleSet(R_1)
    R_2 = gerenateDenasRule(puppetModel, model, 5, maxlength=10)
    R_2 = transferRuleSet(R_2)
    return len(R_1 & R_2) / (len(R_1 | R_2))



if __name__ == '__main__':
    baseline_stability()
    print('Denas:', DenasValue())