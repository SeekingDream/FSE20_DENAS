from Pdf_malware.Scripts.utils import *



def generateNewfeature(rule, featureNum, puppetModel , model):
    activationState = calAcStateFromRule(rule, model)
    contributionVec = calContributionVec(puppetModel, activationState)
    for pt in rule:
        contributionVec[int(pt / 2)] = 0
    newfeatureList = []
    for i in range(featureNum):
        newpt = np.argmax(np.abs(contributionVec))
        if contributionVec[newpt] > 0:
            newpt = newpt * 2 + 1
        else:
            newpt = newpt * 2
        pos = int(newpt / 2)
        val = newpt % BIT
        newfeatureList.append([pos, val])
        contributionVec[pos] = 0
    return newfeatureList


def gerenateDenasRule( puppetModel , model, featureNum, maxlength = 10, rule_number = 10):
    RuleSet = [[]]
    while len(RuleSet):
        rule = RuleSet[0]
        RuleSet = RuleSet[1:]

        if len(rule) == maxlength:
            return RuleSet
        else:
            newrule = [r[0] * 2 + r[1] for r in rule]
            newfeatureList = generateNewfeature(newrule, featureNum, puppetModel , model)
            for pt in newfeatureList:
                cp_rule = rule.copy()
                cp_rule.append(pt)
                RuleSet.append(cp_rule)
            RuleSet = RuleSet[:rule_number]
    return RuleSet